[{"name":"app.R","content":"library(shiny)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(pracma)\n\n# Load data and model\nload(\"data/prosail_data.RData\")\n# source(\"R/reconstruction_model.R\") # Shiny auto-sources files in R/ directory\n\n# Define UI\nui <- fluidPage(\n    withMathJax(),\n    titlePanel(\"Spectral Reconstruction Analysis\"),\n    sidebarLayout(\n        sidebarPanel(\n            sliderInput(\"sample_idx\", \"Select Sample Index:\",\n                min = 1, max = nrow(spectra_mat), value = 1, step = 1\n            ),\n            hr(),\n            h4(\"Reconstructed Parameters\"),\n            tableOutput(\"params_table\"),\n            hr(),\n            helpText(\"Adjust the slider to view different samples from the PROSAIL dataset.\")\n        ),\n        mainPanel(\n            tabsetPanel(\n                tabPanel(\n                    \"Visualisation\",\n                    plotOutput(\"main_plot\", height = \"500px\"),\n                    h4(\"Model Performance\"),\n                    verbatimTextOutput(\"metrics\")\n                ),\n                tabPanel(\n                    \"Error Analysis\",\n                    plotOutput(\"error_plot\", height = \"500px\")\n                ),\n                tabPanel(\n                    \"Equations\",\n                    h3(\"Mathematical Model\"),\n                    p(\"The spectrum is reconstructed using a piecewise approach with three segments:\"),\n                    h4(\"1. Visible Region (400 - 680 nm)\"),\n                    p(\"Modeled as a linear baseline minus two Gaussian absorption features (Chlorophyll at 670nm and Blue absorption at 450nm).\"),\n                    uiOutput(\"eq_vis\"),\n                    h4(\"2. Red Edge (680 - 780 nm)\"),\n                    p(\"Modeled using a 4-parameter logistic function.\"),\n                    uiOutput(\"eq_re\"),\n                    h4(\"3. NIR Plateau (780 - 1100 nm)\"),\n                    p(\"Modeled as a linear baseline minus a Gaussian water absorption feature at 980nm.\"),\n                    uiOutput(\"eq_nir\")\n                )\n            )\n        )\n    )\n)\n\n# Define Server\nserver <- function(input, output) {\n    # Reactive reconstruction\n    reconstruction <- reactive({\n        idx <- input$sample_idx\n        obs_spectrum <- spectra_mat[idx, ]\n\n        # Create named vector for the function\n        names(obs_spectrum) <- paste0(\"R\", wavelengths)\n\n        # Reconstruct\n        res <- reconstruct_spectrum(obs_spectrum, wavelengths)\n\n        list(\n            obs = obs_spectrum,\n            rec = res$spectrum,\n            features = res$features\n        )\n    })\n\n    # Main Plot\n    output$main_plot <- renderPlot({\n        data <- reconstruction()\n\n        df <- data.frame(\n            Wavelength = wavelengths,\n            Reflectance = as.numeric(data$obs),\n            Type = \"Reference\"\n        )\n\n        df_rec <- data.frame(\n            Wavelength = wavelengths,\n            Reflectance = data$rec,\n            Type = \"Reconstructed\"\n        )\n\n        plot_df <- rbind(df, df_rec)\n\n        ggplot(plot_df, aes(x = Wavelength, y = Reflectance, color = Type)) +\n            geom_line(size = 1) +\n            scale_color_manual(values = c(\"Reference\" = \"black\", \"Reconstructed\" = \"red\")) +\n            theme_minimal() +\n            labs(\n                title = paste(\"Sample\", input$sample_idx, \"- Reference vs Reconstruction\"),\n                y = \"Reflectance\", x = \"Wavelength (nm)\"\n            ) +\n            theme(legend.position = \"top\", text = element_text(size = 14))\n    })\n\n    # Error Plot\n    output$error_plot <- renderPlot({\n        data <- reconstruction()\n\n        error <- data$rec - as.numeric(data$obs)\n\n        df_err <- data.frame(\n            Wavelength = wavelengths,\n            Error = error\n        )\n\n        ggplot(df_err, aes(x = Wavelength, y = Error)) +\n            geom_line(color = \"blue\", size = 1) +\n            geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray\") +\n            theme_minimal() +\n            labs(\n                title = \"Reconstruction Error (Reconstructed - Reference)\",\n                y = \"Error\", x = \"Wavelength (nm)\"\n            ) +\n            theme(text = element_text(size = 14))\n    })\n\n    # Parameters Table\n    output$params_table <- renderTable(\n        {\n            feats <- reconstruction()$features\n\n            data.frame(\n                Parameter = c(\n                    \"A (Chl)\", \"Sigma (Chl)\", \"A (Blue)\", \"Sigma (Blue)\",\n                    \"Lambda_i\", \"C (Slope)\", \"A (Water)\", \"Sigma (Water)\", \"AUC (NIR)\"\n                ),\n                Value = sprintf(\"%.4f\", c(\n                    feats$A, feats$sigma, feats$A_blue, feats$sigma_blue,\n                    feats$lambda_i, feats$C, feats$A_water, feats$sigma_water, feats$AUC\n                ))\n            )\n        },\n        colnames = FALSE\n    )\n\n    # Metrics\n    output$metrics <- renderText({\n        data <- reconstruction()\n        rmse <- sqrt(mean((data$rec - as.numeric(data$obs))^2))\n        paste(\"RMSE:\", round(rmse, 5))\n    })\n\n    # Equations\n    output$eq_vis <- renderUI({\n        withMathJax(\n            \"$$ R_{vis}(\\\\lambda) = R_{base}(\\\\lambda) - A \\\\cdot \\\\exp\\\\left(-\\\\frac{(\\\\lambda - 670)^2}{2\\\\sigma^2}\\\\right) - A_{blue} \\\\cdot \\\\exp\\\\left(-\\\\frac{(\\\\lambda - 450)^2}{2\\\\sigma_{blue}^2}\\\\right) $$\"\n        )\n    })\n\n    output$eq_re <- renderUI({\n        withMathJax(\n            \"$$ R_{re}(\\\\lambda) = R_{min} + \\\\frac{R_{max} - R_{min}}{1 + \\\\exp(C(\\\\lambda_i - \\\\lambda))} $$\"\n        )\n    })\n\n    output$eq_nir <- renderUI({\n        withMathJax(\n            \"$$ R_{nir}(\\\\lambda) = R_{nir\\\\_base}(\\\\lambda) - A_{water} \\\\cdot \\\\exp\\\\left(-\\\\frac{(\\\\lambda - 980)^2}{2\\\\sigma_{water}^2}\\\\right) $$\"\n        )\n    })\n}\n\n# Run the application\nshinyApp(ui = ui, server = server)\n","type":"text"}]
